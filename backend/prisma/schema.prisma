generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model App {
  id          BigInt    @id @default(autoincrement())
  name        String    @db.VarChar(255)
  appKey      String    @map("app_key") @db.VarChar(100)
  platform    String    @db.VarChar(20)
  arch        String    @db.VarChar(20)
  description String?   @db.Text
  status      String    @default("active") @db.VarChar(20)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  versions    Version[]

  @@unique([appKey, platform, arch])
  @@map("apps")
}

model Version {
  id              BigInt   @id @default(autoincrement())
  appId           BigInt   @map("app_id")
  appVersion      String   @map("app_version") @db.VarChar(50)
  rendererVersion String   @map("renderer_version") @db.VarChar(50)
  versionCode     BigInt   @map("version_code")
  description     String?  @db.Text
  releaseNotes    String?  @map("release_notes") @db.Text
  installerFileId BigInt?  @map("installer_file_id")
  patchFileId     BigInt?  @map("patch_file_id")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  app             App      @relation(fields: [appId], references: [id], onDelete: Cascade)
  installerFile   File?    @relation("InstallerFile", fields: [installerFileId], references: [id])
  patchFile       File?    @relation("PatchFile", fields: [patchFileId], references: [id])

  @@index([appId])
  @@index([versionCode])
  @@index([installerFileId], map: "versions_installer_file_id_fkey")
  @@index([patchFileId], map: "versions_patch_file_id_fkey")
  @@map("versions")
}

model File {
  id                BigInt    @id @default(autoincrement())
  type              FileType
  originalName      String?   @map("original_name") @db.VarChar(255)
  size              BigInt?
  sha256            String?   @db.VarChar(64)
  storagePath       String?   @map("storage_path") @db.Text
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  installerVersions Version[] @relation("InstallerFile")
  patchVersions     Version[] @relation("PatchFile")

  @@index([sha256])
  @@map("files")
}

enum FileType {
  installer
  patch
  meta
}
